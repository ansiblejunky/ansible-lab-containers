== Overview

Simple triple jump ssh demo using `ProxyJump` directive in an `ssh.cfg`
In this scenario your host machine and the `control` container cannot directly reach `target`.
2 `ssh` jumpboxes sit between `control` and `target`.

Host -> control -> jump_1 -> jump_2 -> target


=== Usage

To test directly with `ssh` from your host (laptop typically).

[source,bash]
----
docker compose up -d
ssh -F ssh.cfg target
----

=== Ansible example

Simple `ansible.cfg` to show one way of using an external `ssh.cfg` file


[source,bash]
----
[defaults]
inventory                   = inventory

[ssh_connection]
ssh_args                    = -F ./ssh.cfg
----

And a simple `inventory`


[source,bash]
----
----
[far_away_host]
target

[control_node]
control

[jumpboxes]
jump_1
jump_2

. Example usage

[source,bash]
----
ansible all -m ping
Friday 14 May 2021  11:24:03 -0600 (0:00:00.203)       0:00:00.203 ************
control | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
jump_1 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
target | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
jump_2 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
----

[docker_container inventory plugin not defaulting ip and port correctly when using ssh connection type](https://github.com/ansible-collections/community.docker/issues/193)

```
docker compose up -d
docker compose up --scale target=100 -d
ansible targets -m ping -i docker.yml

# Get host IP address
ipconfig getifaddr en0

# Get IP of target container
docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' docker_target_1

# Get publicized port for control node for ssh connection
docker port control

# Test direct SSH to control node
# Using this syntax: ssh -i <absolute-path-to-pem> devops@localhost -p <published-container-port>
ssh -i /Users/jwadleig/Projects/ansible-lab-containers/devops.pem devops@localhost -p 5222
```

```
ssh -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o 'ProxyCommand=ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /Users/jwadleig/Projects/ansible-lab-containers/devops.pem -W %h:%p -q devops@localhost -p 5222' -i /Users/jwadleig/Projects/ansible-lab-containers/devops.pem lab-ssh-jump_target_1

ansible_ssh_common_args: -i /Users/jwadleig/Projects/ansible-lab-containers/devops.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand='ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /Users/jwadleig/Projects/ansible-lab-containers/devops.pem -W %h:%p -q devops@localhost -p 5222'


ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /Users/jwadleig/Projects/ansible-lab-containers/devops.pem -o ProxyCommand="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 5222 -i devops.pem -W %h:%p devops@localhost" ansible-lab-containers_target_1

ssh -A -J bastion@127.0.0.1:5222 devops@ansible-lab-containers_target_1

ansible_ssh_common_args: -F ./ssh.cfg
```