== Overview

Simple triple jump ssh demo using `ProxyJump` directive in an `ssh.cfg`
In this scenario your host machine and the `control` container cannot directly reach `target`.
2 `ssh` jumpboxes sit between `control` and `target`.

Host -> control -> jump_1 -> jump_2 -> target


=== Usage

To test directly with `ssh` from your host (laptop typically).

[source,bash]
----
docker compose up -d
ssh -F ssh.cfg target
----

=== Ansible example

Simple `ansible.cfg` to show one way of using an external `ssh.cfg` file


[source,bash]
----
[defaults]
inventory                   = inventory

[ssh_connection]
ssh_args                    = -F ./ssh.cfg
----

And a simple `inventory`


[source,bash]
----
----
[far_away_host]
target

[control_node]
control

[jumpboxes]
jump_1
jump_2

. Example usage

[source,bash]
----
ansible all -m ping
Friday 14 May 2021  11:24:03 -0600 (0:00:00.203)       0:00:00.203 ************
control | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
jump_1 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
target | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
jump_2 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
----

[docker_container inventory plugin not defaulting ip and port correctly when using ssh connection type](https://github.com/ansible-collections/community.docker/issues/193)

[Vagrant Insecure Keypair](https://github.com/hashicorp/vagrant/tree/master/keys)

[source,bash]
----
# Startup containers
docker compose up -d
docker compose up --scale target=100 -d

# Perform Ansible connection tests
ansible all -m ping
ansible all -m ping --forks=20

# Shutdown all containers
docker compose down
----

[source,bash]
----
ansible-inventory -i docker.yml --list

ansible targets -m ping

# Get host IP address
ipconfig getifaddr en0

# Get IP of target container
docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ansible_target_1

# Get publicized port for control node for ssh connection
docker port bastion

# Test direct SSH to control node
# Using this syntax: ssh -i <path-to-pem> devops@localhost -p <published-container-port>
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i devops.pem devops@localhost -p 5222

----
